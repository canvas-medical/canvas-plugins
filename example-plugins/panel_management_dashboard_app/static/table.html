<div class="filters">
    <input
        name="patient_search"
        type="text"
        class="filter-input"
        placeholder="Patient name..."
        value="{{ patient_search }}"
        hx-get="/plugin-io/api/panel_management_dashboard_app/app/table?facility_id={{ facility.id }}&staff_id={{ current_staff.id }}"
        hx-trigger="input changed delay:1000ms, keyup[key=='Enter']"
    >
    <select
        name="staff_id"
        class="filter-select"
        hx-get="/plugin-io/api/panel_management_dashboard_app/app/table?facility_id={{ facility.id }}&patient_search={{ patient_search }}"
        hx-target="#table"
        hx-swap="innerHTML"
    >
        <option value="">Care team: Any</option>
        {% for member in staff %}
        <option
            value="{{ member.id }}"
            {% if current_staff and current_staff.id == member.id %}selected{% endif %}
        >{{ member.first_name }} {{ member.last_name }}</option>
        {% endfor %}
    </select>
</div>

<div id="table">
    <table class="patient-table">
        <thead>
            <tr>
                <th>Patient</th>
                <th>Care Team</th>
                <th>Last Visit</th>
                <th>Triage</th>
                <th>Tasks</th>
                <th>Gaps</th>
                <th>Primary Ins</th>
                <th>Sticky Notes</th>
            </tr>
        </thead>
        <tbody>
            {% for patient in patients %}
            <tr>
                <td>
                    <div class="patient-info">
                        <div class="patient-avatar">
                            <img src="{{ patient.photo_url }}" alt="{{ patient.name }}'s photo">
                        </div>
                        <div>
                            <div class="patient-name">{{ patient.name }}</div>
                            <div class="patient-details">{{ patient.age }} - {{ patient.gender }} - {{ patient.telecom }}
                            </div>
                        </div>
                    </div>
                </td>
                {% if patient.provider %}
                <td class="care-team">{{ patient.provider.first_name }} {{ patient.provider.last_name }} ({{ patient.provider.role }})</td>
                {% else %}
                <td class="care-team">No assigned care team</td>
                {% endif %}
                {% if patient.last_visit %}
                <td class="visit-date overdue">{{ patient.last_visit }}</td>
                {% else %}
                <td class="visit-date">No visits</td>
                {% endif %}
                <td class="triage">
                    <input type="radio" class="triage-input" placeholder="Triage">
                </td>
                <td class="fraction">{{ patient.tasks.open }}/{{ patient.tasks.all }}</td>
                <td class="fraction">{{ patient.gaps.due }}/{{ patient.gaps.total }}</td>
                <td class="insurance">
                    {% if patient.insurance %}
                    <span class="icon-symbol">{{ patient.insurance }}</span>
                    {% else %}
                    <span class="icon-symbol">‚ùì</span>
                    {% endif %}
                </td>
                <td class="sticky-notes">
                    <input name="sticky_note-{{ patient.id }}" type="text" class="sticky-note-input" placeholder="Type">
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if pagination.total_pages > 1 %}
    <div class="pagination">
        <button
            class="pagination-button"
            hx-get="/plugin-io/api/panel_management_dashboard_app/app/table?page={{ pagination.previous_page }}&limit={{ pagination.limit }}&facility_id={{ facility.id }}&staff_id={{ current_staff.id }}&patient_search={{ patient_search }}"
            hx-target="#table"
            hx-swap="innerHTML"
            {% if pagination.current_page == 1 %}disabled{% endif %}
        >Previous</button>
        <span class="pagination-info">Page {{ pagination.current_page }} of {{ pagination.total_pages }}</span>
        <button
            class="pagination-button"
            hx-get="/plugin-io/api/panel_management_dashboard_app/app/table?page={{ pagination.next_page }}&limit={{ pagination.limit }}&facility_id={{ facility.id }}&staff_id={{ current_staff.id }}&patient_search={{ patient_search }}"
            hx-target="#table"
            hx-swap="innerHTML"
            {% if pagination.current_page == pagination.total_pages %}disabled{% endif %}
        >Next</button>
    </div>
    {% endif %}
</div>